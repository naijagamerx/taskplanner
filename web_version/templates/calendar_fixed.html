{% extends "base.html" %}

{% block title %}Task Planner Web - Calendar{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-calendar3"></i> Calendar</h2>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-primary active" id="monthViewBtn" onclick="switchView('month')">Month</button>
                <button type="button" class="btn btn-outline-primary" id="weekViewBtn" onclick="switchView('week')">Week</button>
                <button type="button" class="btn btn-outline-primary" id="dayViewBtn" onclick="switchView('day')">Day</button>
            </div>
        </div>
    </div>
</div>

<!-- Calendar Navigation -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <button class="btn btn-outline-secondary" onclick="navigateCalendar(-1)">
                        <i class="bi bi-chevron-left"></i> Previous
                    </button>
                    <h4 id="currentPeriod" class="mb-0">December 2024</h4>
                    <button class="btn btn-outline-secondary" onclick="navigateCalendar(1)">
                        Next <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
                <div class="text-center mt-2">
                    <button class="btn btn-primary btn-sm" onclick="goToToday()">Today</button>
                    <button class="btn btn-success btn-sm ms-2" onclick="addTaskForDate()">
                        <i class="bi bi-plus-circle"></i> Add Task for Selected Date
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Calendar Container -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body calendar-container">
                <div id="calendarContainer">
                    <div class="text-center py-4">
                        <button class="btn btn-primary" onclick="loadCalendarNow()">
                            <i class="bi bi-calendar-check"></i> Load Calendar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Simple calendar variables
let currentDate = new Date();
let calendarTasks = [];
let selectedDate = null;
let currentView = 'month';

// Load calendar function
function loadCalendarNow() {
    console.log('üîß Loading calendar...');
    const container = document.getElementById('calendarContainer');

    container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div><p class="mt-2">Loading...</p></div>';

    fetch('/api/tasks')
        .then(response => {
            console.log('üì° Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('üìä Data received:', data);
            calendarTasks = data.tasks || [];
            renderCalendarView();
        })
        .catch(error => {
            console.error('‚ùå Error:', error);
            container.innerHTML = `
                <div class="alert alert-danger text-center">
                    <h5>Error Loading Calendar</h5>
                    <p>Error: ${error.message}</p>
                    <button class="btn btn-outline-danger" onclick="loadCalendarNow()">
                        <i class="bi bi-arrow-clockwise"></i> Retry
                    </button>
                </div>
            `;
        });
}

// Switch calendar view
function switchView(view) {
    currentView = view;

    // Update button states
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(view + 'ViewBtn').classList.add('active');

    renderCalendarView();
}

// Render calendar based on current view
function renderCalendarView() {
    const container = document.getElementById('calendarContainer');

    if (currentView === 'month') {
        renderMonthView(container);
    } else if (currentView === 'week') {
        renderWeekView(container);
    } else if (currentView === 'day') {
        renderDayView(container);
    }
}

// Render month view
function renderMonthView(container) {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    // Update period label
    document.getElementById('currentPeriod').textContent =
        currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

    // Get calendar info
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();

    let html = `
        <div class="calendar-month">
            <div class="calendar-header">
                <div class="calendar-day-header">Sun</div>
                <div class="calendar-day-header">Mon</div>
                <div class="calendar-day-header">Tue</div>
                <div class="calendar-day-header">Wed</div>
                <div class="calendar-day-header">Thu</div>
                <div class="calendar-day-header">Fri</div>
                <div class="calendar-day-header">Sat</div>
            </div>
            <div class="calendar-grid">
    `;

    // Empty cells before month starts
    for (let i = 0; i < startingDayOfWeek; i++) {
        html += '<div class="calendar-day empty"></div>';
    }

    // Days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateStr = date.toISOString().split('T')[0];
        const dayTasks = calendarTasks.filter(task => task.due_date === dateStr);
        const isToday = date.toDateString() === new Date().toDateString();
        const isSelected = selectedDate && date.toDateString() === selectedDate.toDateString();

        html += `
            <div class="calendar-day ${isToday ? 'today' : ''} ${isSelected ? 'selected' : ''}"
                 onclick="selectCalendarDate('${dateStr}')">
                <div class="day-number">${day}</div>
                <div class="day-tasks">
                    ${dayTasks.slice(0, 3).map(task => `
                        <div class="task-indicator priority-${task.priority_id || 2}"
                             title="${task.title || 'Untitled'}">
                            ${(task.title || 'Untitled').substring(0, 12)}${(task.title || '').length > 12 ? '...' : ''}
                        </div>
                    `).join('')}
                    ${dayTasks.length > 3 ? `<div class="more-tasks">+${dayTasks.length - 3} more</div>` : ''}
                </div>
            </div>
        `;
    }

    html += '</div></div>';

    // Add status message
    if (calendarTasks.length === 0) {
        html += `
            <div class="alert alert-info mt-3 text-center">
                <i class="bi bi-info-circle"></i> No tasks found.
                <a href="/" class="alert-link">Add your first task</a> to see it on the calendar.
            </div>
        `;
    } else {
        html += `
            <div class="alert alert-success mt-3 text-center">
                <i class="bi bi-check-circle"></i> Showing ${calendarTasks.length} task(s) on calendar.
            </div>
        `;
    }

    container.innerHTML = html;
}

// Render week view
function renderWeekView(container) {
    const startOfWeek = new Date(currentDate);
    startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);

    // Update period label
    document.getElementById('currentPeriod').textContent =
        `${startOfWeek.toLocaleDateString()} - ${endOfWeek.toLocaleDateString()}`;

    container.innerHTML = `
        <div class="week-view">
            <h5><i class="bi bi-calendar-week"></i> Week View</h5>
            <p>Week of ${startOfWeek.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })} - ${endOfWeek.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</p>
            <p class="text-muted">Week view coming soon with detailed daily schedule</p>
        </div>
    `;
}

// Render day view
function renderDayView(container) {
    // Update period label
    document.getElementById('currentPeriod').textContent =
        currentDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

    const dateStr = currentDate.toISOString().split('T')[0];
    const dayTasks = calendarTasks.filter(task => task.due_date === dateStr);

    container.innerHTML = `
        <div class="day-view">
            <h5><i class="bi bi-calendar-day"></i> Day View</h5>
            <p>${currentDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</p>
            <div class="mt-3">
                <strong>Tasks for this day: ${dayTasks.length}</strong>
                ${dayTasks.length > 0 ? `
                    <ul class="list-unstyled mt-2">
                        ${dayTasks.map(task => `
                            <li class="task-indicator priority-${task.priority_id || 2} mb-1 p-2 rounded">
                                ${task.title || 'Untitled Task'}
                            </li>
                        `).join('')}
                    </ul>
                ` : '<p class="text-muted mt-2">No tasks scheduled for this day</p>'}
            </div>
        </div>
    `;
}

// Navigation functions
function navigateCalendar(direction) {
    if (currentView === 'month') {
        currentDate.setMonth(currentDate.getMonth() + direction);
    } else if (currentView === 'week') {
        currentDate.setDate(currentDate.getDate() + (direction * 7));
    } else if (currentView === 'day') {
        currentDate.setDate(currentDate.getDate() + direction);
    }
    renderCalendarView();
}

function goToToday() {
    currentDate = new Date();
    renderCalendarView();
}

function selectCalendarDate(dateStr) {
    selectedDate = new Date(dateStr);
    renderCalendarView();
}

function addTaskForDate() {
    if (selectedDate) {
        window.location.href = '/?add_task=true&date=' + selectedDate.toISOString().split('T')[0];
    } else {
        alert('Please select a date first by clicking on a calendar day.');
    }
}

// Auto-load on page ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìÖ Calendar page ready');
    loadCalendarNow();
});
</script>

<style>
.calendar-month {
    width: 100%;
    max-height: 70vh;
    overflow: hidden;
}
.calendar-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    background-color: #495057;
    margin-bottom: 2px;
    border-radius: 8px 8px 0 0;
}
.calendar-day-header {
    background-color: #0d6efd;
    color: white;
    padding: 8px 4px;
    text-align: center;
    font-weight: bold;
    font-size: 0.9rem;
}
.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    background-color: #495057;
    border-radius: 0 0 8px 8px;
}
.calendar-day {
    background-color: #f8f9fa;
    min-height: 80px;
    max-height: 80px;
    padding: 6px;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid #dee2e6;
    overflow: hidden;
}
.calendar-day:hover {
    background-color: #e9ecef;
    transform: scale(1.02);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.calendar-day.today {
    background-color: #cff4fc;
    border: 2px solid #0d6efd;
    font-weight: bold;
}
.calendar-day.selected {
    background-color: #d1e7dd;
    border: 2px solid #198754;
    box-shadow: 0 0 0 2px rgba(25, 135, 84, 0.25);
}
.calendar-day.empty {
    background-color: #e9ecef;
    cursor: default;
    opacity: 0.5;
}
.day-number {
    font-weight: bold;
    margin-bottom: 4px;
    font-size: 0.9rem;
    color: #495057;
}
.calendar-day.today .day-number {
    color: #0d6efd;
}
.day-tasks {
    max-height: 50px;
    overflow: hidden;
}
.task-indicator {
    font-size: 0.65rem;
    padding: 1px 3px;
    margin: 1px 0;
    border-radius: 3px;
    background-color: #6c757d;
    color: white;
    cursor: pointer;
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.task-indicator:hover {
    opacity: 0.8;
    transform: scale(1.05);
}
.task-indicator.priority-1 { background-color: #17a2b8; }
.task-indicator.priority-2 { background-color: #ffc107; color: #000; }
.task-indicator.priority-3 { background-color: #dc3545; }
.task-indicator.priority-4 { background-color: #343a40; }
.more-tasks {
    font-size: 0.6rem;
    color: #6c757d;
    font-style: italic;
    text-align: center;
}

/* View buttons styling */
.btn-group .btn.active {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: white;
}

/* Compact calendar container */
.calendar-container {
    max-height: 75vh;
    overflow-y: auto;
}

/* Week and Day view styles */
.week-view, .day-view {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>
{% endblock %}
